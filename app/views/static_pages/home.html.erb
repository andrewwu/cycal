<div class="container">

<div class="cal-1">
  <script type="text/template" id="template-calendar">

    <div class="row">
      <div class="col-md-6">
        <div class="clndr-controls btn-group">

          <div class="clndr-previous-button btn btn-default">
            <span class="glyphicon glyphicon-chevron-left"></span>
          </div>

          <div class="month btn btn-default"><%%= month + " " + year %></div>

          <div class="clndr-next-button btn btn-default">
            <span class="glyphicon glyphicon-chevron-right"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-2">
        <div class="goal-header">Weekly Goals</div>
        <div class="goals">

          <%% var weekly_total = 0; %>

          <%% _.each(days, function(day, index) { %>

            <%% if (!_.isEmpty(day.events)) { %>
              <%% weekly_total += (day.events[0].duration / 60); %>
            <%% } %>

            <%% if ((index + 1) % 7 == 0 && index != 0) { %>
              <div class="goal"><%%= weekly_total + ' hours' %></div>
              <%% weekly_total = 0; %>
            <%% } %>
          <%% }); %>

        </div>
      </div>

      <div class="col-md-10">
        <div class="clndr-grid">
          <div class="days-of-the-week">
            <%% //console.log(_.size(days)); %>
            <%% _.each(daysOfTheWeek, function(day) { %>
              <div class="header-day"><%%= day %></div>
            <%% }); %>

            <div class="clearfix"></div>

            <div class="days">
              <%% _.each(days, function(day, index) { %>
                <%% //console.log('index is ' + index); %>

                <div class="<%%= day.classes %> <%%= day.date.format('ddd').toLowerCase() %>" data-index="<%%= index %>" data-toggle="modal" data-target="#activityForm" data-date="<%%= day.date.format('GGGG-MM-DD') %>">
                  <span class="options"></span>
                  <span class="clndr-day pull-right"><%%= day.day %></span>

                  <%% if (!_.isEmpty(day.events)) { %>
                    <%% var category = categoryArray[day.events[0].category_id]; %>
                    <div class="activity" style="background-color: <%%= category.color %>;">

                      <div class="duration">
                        <%%= day.events[0].duration / 60 + " h" %>
                      </div>

                      <div class="category">
                        <%%= category['label'] %>
                      </div>

                    </div>
                  <%% } %>
                </div>

              <%% }); %>

              <div class="clearfix"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </script>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="activityForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">New Activity</h4>
      </div>
      <div class="modal-body">

        <form class="form-horizontal" role="form">
          <div class="form-group">
            <label for="inputEmail3" class="col-sm-2 control-label">Duration</label>
            <div class="col-sm-10">
              <div class="input-group">
                <input id="hours" type="text" class="form-control">
                <span class="input-group-addon">h</span>
                <input id="minutes" type="text" class="form-control">
                <span class="input-group-addon">m</span>
              </div>  
            </div>
          </div>
          <div class="form-group">
            <label for="category" class="col-sm-2 control-label">Category</label>
            <div class="col-sm-10">
              <select id="category" class="form-control chosen-select">
                <option value="0">Zone 2</option>
                <option value="1">Sprint Workout</option>
                <option value="2">Threshold Test</option>
              </select>
            </div>
          </div>
        </form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger pull-left">Delete</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<script>

  // TODO: load and store this event array from localstorage
/*

  var categoryArray = [
    { label: "Zone 2", color: "#A9E2F3" },
    { label: "Sprint Workout", color: "#F5DA81" },
    { label: "Threshold Test", color: "#F5A9A9" }
  ]

  var eventArray = [
    { date: "2014-01-01", duration: 120, category_id: 0 },
    { date: "2014-01-02", duration: 90, category_id: 0 },
    { date: "2014-01-04", duration: 180, category_id: 0 },
    { date: "2014-01-05", duration: 120, category_id: 0 },

    { date: "2014-01-07", duration: 90, category_id: 0 },
    { date: "2014-01-08", duration: 120, category_id: 0 },
    { date: "2014-01-09", duration: 90, category_id: 0 },
    { date: "2014-01-11", duration: 180, category_id: 0 },
    { date: "2014-01-12", duration: 120, category_id: 0},

    { date: "2014-01-14", duration: 90, category_id: 0 },
    { date: "2014-01-15", duration: 120, category_id: 0 },
    { date: "2014-01-16", duration: 90, category_id: 0 },
    { date: "2014-01-18", duration: 120, category_id: 0 },
    { date: "2014-01-19", duration: 120, category_id: 2 },

    { date: "2014-01-21", duration: 120, category_id: 0 },
    { date: "2014-01-22", duration: 120, category_id: 0 },
    { date: "2014-01-23", duration: 90, category_id: 0 },
    { date: "2014-01-25", duration: 270, category_id: 0 },
    { date: "2014-01-26", duration: 180, category_id: 0 },

    { date: "2014-01-28", duration: 120, category_id: 1 },
    { date: "2014-01-29", duration: 150, category_id: 0 },
    { date: "2014-01-30", duration: 120, category_id: 0 },

    { date: "2014-02-01", duration: 300, category_id: 0 },
    { date: "2014-02-02", duration: 180, category_id: 0 }
  ];*/
  

  var categoryArray = new Array();
  var eventArray = new Array();

  function loadEvents() {
    if (!Modernizr.localstorage) { return false; }


    // TODO: change these to constant keys
    if (localStorage['events'] !== null && localStorage['categories'] !== null) {
      console.log('events exist');
      eventArray = JSON.parse(localStorage['events']);
      categoryArray = JSON.parse(localStorage['categories']);
      myCal.setEvents(eventArray);
    } else {
      // no previous data
    }
  }

  $(function() {
    loadEvents();
  });

  function saveEvents() {
    if (Modernizr.localstorage) {
      localStorage['events'] = JSON.stringify(eventArray);
      localStorage['categories'] = JSON.stringify(categoryArray);
    } else {
      // TODO: no localstorage support
    }
  }

  $(function(){
    $('.chosen-select').chosen({ width: '100%' });
  });

  var myCal = $('.cal-1').clndr({
    daysOfTheWeek: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
    template: $('#template-calendar').html(),
    events: eventArray,
    weekOffset: 1 
  });


  $(document).on('click', '[data-toggle="modal"]', function() {
    var event = $(this).hasClass('event');

    $('#activityForm').data('date', $(this).data('date'));
    console.log('modifying date: ' + $(this).data('date'));


    if (event) {
      var index = parseInt($(this).data('index'));
      console.log(myCal);
      $('.modal').data('mode', 'edit');
      setModalMode('edit');

    } else {
      // new event
      console.log('no event'); 
      setModalMode('new');

    }
  });

  function setModalMode(mode) {
    console.log("setting mode to " + mode);
    $('#activityForm').data('mode', mode);

    if (mode == 'new') {
      $('.btn-danger').hide();
      $('#hours').val('');
      $('#minutes').val('');
      $('#category').val('0');
    } else {
      // edit mode
      $('.btn-danger').show();


      // TODO: get the date from the event array

      var date = $('#activityForm').data('date');
      console.log("setting modal mode: " + date);

      var result = $.grep(eventArray, function(e) { return e.date == date });      
      console.log('result is ' + result);
      console.log(result);

      result = result[0];

      var hours = Math.floor(result.duration / 60);
      var minutes = result.duration % 60;
      var category = result.category_id;

      $('#hours').val(hours);
      $('#minutes').val(minutes);
      $('#category').val(category);
    }

    $('#category').trigger('chosen:updated');
    console.log("mode is " + $('#activityForm').data('mode'));
  }

  $('.btn-danger').click(function() {
    if (confirm('Are you sure?')) {
      console.log('get and delete the event'); 
      $('.modal').modal('hide');


      var date = $('#activityForm').data('date');
      console.log('deleting: ' + date);
      var result = $.grep(eventArray, function(e) { return e.date == date });   
      result = result[0];
      var index = eventArray.indexOf(result);
      console.log('index is ' + index);
      eventArray.splice(index, 1);
      myCal.setEvents(eventArray);

      // TODO: actually remove the event
      saveEvents();
    }
  });

  function inEditMode() {
    return $('.modal').data('mode') == 'edit';
  }

  $('.btn-primary').click(function() {
    var date = $('#activityForm').data('date');

    console.log('clicked save for date: ' + date)

    // TODO: validation here

    var hours = parseInt($('#hours').val());
    var minutes = parseInt($('#minutes').val());
    var category_id = $('#category').val();
    var duration = (hours * 60) + minutes;

    var event = {
      date: date,
      duration: duration,
      category_id: category_id
    }


    // TODO: toss into add edit methods

    if (inEditMode()) {
      console.log('update and save');
      // update events array [x]

      var result = $.grep(eventArray, function(e) { return e.date == date });   
      result = result[0];
      var index = eventArray.indexOf(result);

      eventArray[index] = event;

      // TODO: actually update
    } else {
      // get implied date
      console.log('create new');
      // insert into events array[x]
      // TODO: actually add the event
      // myCal.setEvents(eventArray);
      console.log('event array length ' + eventArray.length);

      
      console.log('duration is new' + duration);

      eventArray.push(event);

      // APPEND The array?
      //myCal.addEvents(additionalEventsArray);
      console.log('event array length after ' + eventArray.length);
    }

    // refresh calendar
    myCal.setEvents(eventArray);
    saveEvents();
    // TODO: validation
    $('.modal').modal('hide');
  });

  </script>
